# Changelog - 12/01/2025

## üéØ Objetivo
Corrigir problema na funcionalidade de duplica√ß√£o de cursos onde o formul√°rio ficava travado na tela de loading ap√≥s apresentar erros de valida√ß√£o.

## Problema Identificado

### Sintomas
- Ao clicar em "Salvar" na duplica√ß√£o de cursos, o sistema apresentava erros de valida√ß√£o
- A p√°gina ficava travada na tela de loading (JavaScript)
- Usu√°rio n√£o conseguia ver as mensagens de erro nem voltar ao formul√°rio

### Causa Raiz
Dois problemas principais foram identificados:

1. **Valida√ß√£o muito restritiva**: Quando um usu√°rio duplicava um curso e mudava a modalidade (ex: de Presencial para Online), os campos da modalidade anterior permaneciam preenchidos no formul√°rio. A valida√ß√£o rejeitava esses dados, gerando erros como:
   - "Campo 'Endereco Unidade' n√£o deve ser preenchido para cursos online"
   - "Campo 'Bairro Unidade' n√£o deve ser preenchido para cursos online"

2. **Loading screen n√£o desaparecia**: Quando havia erros de valida√ß√£o e a p√°gina era redirecionada de volta ao formul√°rio, o overlay de loading n√£o era removido, deixando a interface inacess√≠vel.

## Corre√ß√µes Implementadas

### 1. Loading Manager - Detec√ß√£o de Erros
**Arquivo:** `static/js/loading-manager.js`

Adicionada l√≥gica para detectar mensagens de erro na p√°gina e fechar o loading automaticamente:

```javascript
// CORRE√á√ÉO: Esconder loading se houver mensagens de erro na p√°gina
setTimeout(function() {
    const hasErrors = document.querySelector('.alert-error, .alert-warning');
    if (hasErrors && window.loadingManager) {
        console.log('‚ö†Ô∏è Erros detectados na p√°gina, fechando loading...');
        window.loadingManager.hide();
    }
}, 100);
```

**Impacto:** O loading agora fecha automaticamente quando h√° erros de valida√ß√£o, permitindo que o usu√°rio veja as mensagens de erro.

### 2. Limpeza de Dados por Modalidade
**Arquivo:** `services/course_service.py`

Criada nova fun√ß√£o `_clean_form_data_by_modality()` que limpa campos incompat√≠veis com a modalidade selecionada **antes** da valida√ß√£o:

```python
def _clean_form_data_by_modality(self, form_data):
    """
    Limpa campos do formul√°rio que n√£o s√£o aplic√°veis √† modalidade selecionada
    """
    from werkzeug.datastructures import MultiDict
    
    modalidade = form_data.get('modalidade', '')
    cleaned_data = MultiDict()
    
    # Copiar todos os dados primeiro
    if hasattr(form_data, 'items'):
        for key in form_data.keys():
            values = form_data.getlist(key) if hasattr(form_data, 'getlist') else [form_data.get(key)]
            for value in values:
                cleaned_data.add(key, value)
    
    # Para cursos online, limpar campos presenciais
    if modalidade == 'Online':
        campos_presenciais = [
            'endereco_unidade[]',
            'bairro_unidade[]',
            'complemento[]'
        ]
        
        for campo in campos_presenciais:
            if campo in cleaned_data:
                valores = cleaned_data.getlist(campo)
                cleaned_data.setlist(campo, [''] * len(valores) if valores else [])
                logger.info(f"üßπ Limpando campo presencial para curso online: {campo}")
    
    return cleaned_data
```

**Aplica√ß√£o:** A fun√ß√£o √© chamada em `create_course()` e `update_course()` antes da valida√ß√£o:

```python
def create_course(self, form_data: Dict, files: Dict = None, user_id: int = None):
    try:
        # CORRE√á√ÉO: Limpar campos inv√°lidos baseado na modalidade antes da valida√ß√£o
        form_data = self._clean_form_data_by_modality(form_data)
        
        # Validar dados
        is_valid, errors, warnings = self.validator.validate_course_data(form_data)
        # ...
```

**Impacto:** Campos incompat√≠veis com a modalidade s√£o automaticamente limpos, evitando erros de valida√ß√£o desnecess√°rios.

### 3. Melhoria na Valida√ß√£o de Campos Online
**Arquivo:** `services/validation_service.py`

Melhorada a l√≥gica de valida√ß√£o para usar `getlist()` corretamente ao verificar campos de array:

```python
# Validar campos que nunca devem estar presentes (endere√ßo e bairro)
# CORRE√á√ÉO: Usar getlist para obter valores corretos de arrays
for field in presencial_fields:
    if hasattr(form_data, 'getlist'):
        field_value = form_data.getlist(field)
    else:
        field_value = form_data.get(field, [])
    
    # Verificar se h√° valores n√£o vazios
    if isinstance(field_value, list):
        valores_nao_vazios = [item.strip() for item in field_value if item and item.strip()]
        if valores_nao_vazios:
            field_name = field.replace('[]', '').replace('_', ' ').title()
            self.errors.append(f"Campo '{field_name}' n√£o deve ser preenchido para cursos online")
```

**Impacto:** Valida√ß√£o mais precisa de campos de array, evitando falsos positivos.

### 4. Logs Detalhados para Debug
**Arquivo:** `app.py`

Adicionados logs detalhados na rota de duplica√ß√£o para facilitar debugging:

```python
# Log espec√≠fico para campos cr√≠ticos
logger.info("=== DEBUG DUPLICA√á√ÉO ===")
logger.info(f"modalidade: {request.form.get('modalidade')}")
logger.info(f"aulas_assincronas: {request.form.get('aulas_assincronas')}")
logger.info(f"horario_inicio[]: {request.form.getlist('horario_inicio[]')}")
logger.info(f"horario_fim[]: {request.form.getlist('horario_fim[]')}")
logger.info(f"endereco_unidade[]: {request.form.getlist('endereco_unidade[]')}")
logger.info(f"vagas_unidade[]: {request.form.getlist('vagas_unidade[]')}")
logger.info("========================")
```

## Testes Realizados

### Teste 1: Valida√ß√£o B√°sica
Criado script de teste `test_duplicate_validation.py` para validar dados de curso online:

```python
form_data = ImmutableMultiDict([
    ('modalidade', 'Online'),
    ('vagas_unidade[]', '50'),
    # ... outros campos
])

validator = CourseValidator()
is_valid, errors, warnings = validator.validate_course_data(form_data)
# Resultado: V√°lido: True, Erros: 0
```

### Teste 2: Curso Online com Campos Presenciais
Testado cen√°rio problem√°tico com campos presenciais preenchidos:

```python
form_data = ImmutableMultiDict([
    ('modalidade', 'Online'),
    ('endereco_unidade[]', 'Rua Teste, 123'),
    ('bairro_unidade[]', 'Centro'),
    # ... outros campos
])

# Antes da corre√ß√£o:
# Resultado: V√°lido: False, Erros: 2

# Depois da corre√ß√£o (com limpeza):
cleaned_data = service._clean_form_data_by_modality(form_data)
# Resultado: V√°lido: True, Erros: 0
```

## Arquivos Modificados

1. **static/js/loading-manager.js**
   - Adicionada detec√ß√£o autom√°tica de erros para fechar loading

2. **services/course_service.py**
   - Nova fun√ß√£o `_clean_form_data_by_modality()`
   - Aplicada limpeza em `create_course()` e `update_course()`

3. **services/validation_service.py**
   - Melhorada valida√ß√£o de campos de array com `getlist()`

4. **app.py**
   - Adicionados logs detalhados na rota de duplica√ß√£o

5. **templates/course_duplicate.html**
   - Melhorada l√≥gica de limpeza de campos no JavaScript (complementar)

## Resultado

### Antes
- ‚ùå Duplica√ß√£o de cursos falhava com erros de valida√ß√£o
- ‚ùå Tela ficava travada no loading
- ‚ùå Usu√°rio n√£o conseguia ver mensagens de erro

### Depois
- ‚úÖ Campos incompat√≠veis s√£o limpos automaticamente
- ‚úÖ Loading fecha quando h√° erros de valida√ß√£o
- ‚úÖ Mensagens de erro s√£o exibidas corretamente
- ‚úÖ Usu√°rio pode corrigir e tentar novamente

## Impacto

- **Experi√™ncia do Usu√°rio:** Duplica√ß√£o de cursos agora funciona de forma fluida, mesmo ao mudar modalidades
- **Manutenibilidade:** L√≥gica de limpeza centralizada facilita futuras manuten√ß√µes
- **Debugging:** Logs detalhados facilitam identifica√ß√£o de problemas
- **Robustez:** Sistema mais tolerante a dados inconsistentes do formul√°rio

## Observa√ß√µes

- A limpeza de dados √© feita no servidor (Python) para garantir seguran√ßa
- O JavaScript complementa com limpeza visual, mas n√£o √© a √∫nica linha de defesa
- A valida√ß√£o continua rigorosa, mas agora trabalha com dados j√° limpos
- Logs detalhados permitem monitorar o comportamento em produ√ß√£o
