# Changelog - 12/01/2025

## üéØ Objetivo
Corrigir problema na funcionalidade de duplica√ß√£o de cursos onde o formul√°rio ficava travado na tela de loading ap√≥s apresentar erros de valida√ß√£o.

## Problema Identificado

### Sintomas
- Ao clicar em "Salvar" na duplica√ß√£o de cursos, o sistema apresentava erros de valida√ß√£o
- A p√°gina ficava travada na tela de loading (JavaScript)
- Usu√°rio n√£o conseguia ver as mensagens de erro nem voltar ao formul√°rio

### Causa Raiz
Dois problemas principais foram identificados:

1. **Valida√ß√£o muito restritiva**: Quando um usu√°rio duplicava um curso e mudava a modalidade (ex: de Presencial para Online), os campos da modalidade anterior permaneciam preenchidos no formul√°rio. A valida√ß√£o rejeitava esses dados, gerando erros como:
   - "Campo 'Endereco Unidade' n√£o deve ser preenchido para cursos online"
   - "Campo 'Bairro Unidade' n√£o deve ser preenchido para cursos online"

2. **Loading screen n√£o desaparecia**: Quando havia erros de valida√ß√£o e a p√°gina era redirecionada de volta ao formul√°rio, o overlay de loading n√£o era removido, deixando a interface inacess√≠vel.

## Corre√ß√µes Implementadas

### 1. Loading Manager - Detec√ß√£o de Erros
**Arquivo:** `static/js/loading-manager.js`

Adicionada l√≥gica para detectar mensagens de erro na p√°gina e fechar o loading automaticamente:

```javascript
// CORRE√á√ÉO: Esconder loading se houver mensagens de erro na p√°gina
setTimeout(function() {
    const hasErrors = document.querySelector('.alert-error, .alert-warning');
    if (hasErrors && window.loadingManager) {
        console.log('‚ö†Ô∏è Erros detectados na p√°gina, fechando loading...');
        window.loadingManager.hide();
    }
}, 100);
```

**Impacto:** O loading agora fecha automaticamente quando h√° erros de valida√ß√£o, permitindo que o usu√°rio veja as mensagens de erro.

### 2. Limpeza de Dados por Modalidade
**Arquivo:** `services/course_service.py`

Criada nova fun√ß√£o `_clean_form_data_by_modality()` que limpa campos incompat√≠veis com a modalidade selecionada **antes** da valida√ß√£o:

```python
def _clean_form_data_by_modality(self, form_data):
    """
    Limpa campos do formul√°rio que n√£o s√£o aplic√°veis √† modalidade selecionada
    """
    from werkzeug.datastructures import MultiDict
    
    modalidade = form_data.get('modalidade', '')
    cleaned_data = MultiDict()
    
    # Copiar todos os dados primeiro
    if hasattr(form_data, 'items'):
        for key in form_data.keys():
            values = form_data.getlist(key) if hasattr(form_data, 'getlist') else [form_data.get(key)]
            for value in values:
                cleaned_data.add(key, value)
    
    # Para cursos online, limpar campos presenciais
    if modalidade == 'Online':
        campos_presenciais = [
            'endereco_unidade[]',
            'bairro_unidade[]',
            'complemento[]'
        ]
        
        for campo in campos_presenciais:
            if campo in cleaned_data:
                valores = cleaned_data.getlist(campo)
                cleaned_data.setlist(campo, [''] * len(valores) if valores else [])
                logger.info(f"üßπ Limpando campo presencial para curso online: {campo}")
    
    return cleaned_data
```

**Aplica√ß√£o:** A fun√ß√£o √© chamada em `create_course()` e `update_course()` antes da valida√ß√£o:

```python
def create_course(self, form_data: Dict, files: Dict = None, user_id: int = None):
    try:
        # CORRE√á√ÉO: Limpar campos inv√°lidos baseado na modalidade antes da valida√ß√£o
        form_data = self._clean_form_data_by_modality(form_data)
        
        # Validar dados
        is_valid, errors, warnings = self.validator.validate_course_data(form_data)
        # ...
```

**Impacto:** Campos incompat√≠veis com a modalidade s√£o automaticamente limpos, evitando erros de valida√ß√£o desnecess√°rios.

### 3. Melhoria na Valida√ß√£o de Campos Online
**Arquivo:** `services/validation_service.py`

Melhorada a l√≥gica de valida√ß√£o para usar `getlist()` corretamente ao verificar campos de array:

```python
# Validar campos que nunca devem estar presentes (endere√ßo e bairro)
# CORRE√á√ÉO: Usar getlist para obter valores corretos de arrays
for field in presencial_fields:
    if hasattr(form_data, 'getlist'):
        field_value = form_data.getlist(field)
    else:
        field_value = form_data.get(field, [])
    
    # Verificar se h√° valores n√£o vazios
    if isinstance(field_value, list):
        valores_nao_vazios = [item.strip() for item in field_value if item and item.strip()]
        if valores_nao_vazios:
            field_name = field.replace('[]', '').replace('_', ' ').title()
            self.errors.append(f"Campo '{field_name}' n√£o deve ser preenchido para cursos online")
```

**Impacto:** Valida√ß√£o mais precisa de campos de array, evitando falsos positivos.

### 4. Logs Detalhados para Debug
**Arquivo:** `app.py`

Adicionados logs detalhados na rota de duplica√ß√£o para facilitar debugging:

```python
# Log espec√≠fico para campos cr√≠ticos
logger.info("=== DEBUG DUPLICA√á√ÉO ===")
logger.info(f"modalidade: {request.form.get('modalidade')}")
logger.info(f"aulas_assincronas: {request.form.get('aulas_assincronas')}")
logger.info(f"horario_inicio[]: {request.form.getlist('horario_inicio[]')}")
logger.info(f"horario_fim[]: {request.form.getlist('horario_fim[]')}")
logger.info(f"endereco_unidade[]: {request.form.getlist('endereco_unidade[]')}")
logger.info(f"vagas_unidade[]: {request.form.getlist('vagas_unidade[]')}")
logger.info("========================")
```

## Testes Realizados

### Teste 1: Valida√ß√£o B√°sica
Criado script de teste `test_duplicate_validation.py` para validar dados de curso online:

```python
form_data = ImmutableMultiDict([
    ('modalidade', 'Online'),
    ('vagas_unidade[]', '50'),
    # ... outros campos
])

validator = CourseValidator()
is_valid, errors, warnings = validator.validate_course_data(form_data)
# Resultado: V√°lido: True, Erros: 0
```

### Teste 2: Curso Online com Campos Presenciais
Testado cen√°rio problem√°tico com campos presenciais preenchidos:

```python
form_data = ImmutableMultiDict([
    ('modalidade', 'Online'),
    ('endereco_unidade[]', 'Rua Teste, 123'),
    ('bairro_unidade[]', 'Centro'),
    # ... outros campos
])

# Antes da corre√ß√£o:
# Resultado: V√°lido: False, Erros: 2

# Depois da corre√ß√£o (com limpeza):
cleaned_data = service._clean_form_data_by_modality(form_data)
# Resultado: V√°lido: True, Erros: 0
```

## Arquivos Modificados

1. **static/js/loading-manager.js**
   - Adicionada detec√ß√£o autom√°tica de erros para fechar loading

2. **services/course_service.py**
   - Nova fun√ß√£o `_clean_form_data_by_modality()`
   - Aplicada limpeza em `create_course()` e `update_course()`

3. **services/validation_service.py**
   - Melhorada valida√ß√£o de campos de array com `getlist()`

4. **app.py**
   - Adicionados logs detalhados na rota de duplica√ß√£o

5. **templates/course_duplicate.html**
   - Melhorada l√≥gica de limpeza de campos no JavaScript (complementar)

## Resultado

### Antes
- ‚ùå Duplica√ß√£o de cursos falhava com erros de valida√ß√£o
- ‚ùå Tela ficava travada no loading
- ‚ùå Usu√°rio n√£o conseguia ver mensagens de erro

### Depois
- ‚úÖ Campos incompat√≠veis s√£o limpos automaticamente
- ‚úÖ Loading fecha quando h√° erros de valida√ß√£o
- ‚úÖ Mensagens de erro s√£o exibidas corretamente
- ‚úÖ Usu√°rio pode corrigir e tentar novamente

## Impacto

- **Experi√™ncia do Usu√°rio:** Duplica√ß√£o de cursos agora funciona de forma fluida, mesmo ao mudar modalidades
- **Manutenibilidade:** L√≥gica de limpeza centralizada facilita futuras manuten√ß√µes
- **Debugging:** Logs detalhados facilitam identifica√ß√£o de problemas
- **Robustez:** Sistema mais tolerante a dados inconsistentes do formul√°rio

## Observa√ß√µes

- A limpeza de dados √© feita no servidor (Python) para garantir seguran√ßa
- O JavaScript complementa com limpeza visual, mas n√£o √© a √∫nica linha de defesa
- A valida√ß√£o continua rigorosa, mas agora trabalha com dados j√° limpos
- Logs detalhados permitem monitorar o comportamento em produ√ß√£o


---

## üïê Atualiza√ß√£o: Campos de Hor√°rio com Formato Livre

### Objetivo
Modificar os campos de hor√°rio (in√≠cio e fim) em todas as modalidades para permitir preenchimento livre no formato HH:MM, suportando hor√°rios quebrados como 10:15, 10:30, etc.

### Problema Anterior
- Campos de hor√°rio eram `<select>` com op√ß√µes fixas de hora em hora (06:00, 07:00, 08:00, etc.)
- N√£o era poss√≠vel inserir hor√°rios quebrados como 10:15, 14:45, etc.
- Limitava a flexibilidade na cria√ß√£o de cursos

### Solu√ß√£o Implementada

#### 1. Fun√ß√µes JavaScript para M√°scara e Valida√ß√£o
**Arquivo:** `static/js/script.js`

Adicionadas duas novas fun√ß√µes globais:

```javascript
function formatarHorario(input) {
    // Remove todos os caracteres n√£o num√©ricos
    let valor = input.value.replace(/\D/g, '');
    
    // Limita a 4 d√≠gitos (HHMM)
    if (valor.length > 4) {
        valor = valor.substring(0, 4);
    }
    
    // Adiciona os dois pontos ap√≥s os dois primeiros d√≠gitos
    if (valor.length >= 3) {
        valor = valor.substring(0, 2) + ':' + valor.substring(2);
    }
    
    input.value = valor;
}

function validarHorario(input) {
    const valor = input.value;
    
    // Verifica se est√° no formato XX:XX
    const regex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
    
    if (valor && !regex.test(valor)) {
        input.setCustomValidity('Formato inv√°lido. Use HH:MM (ex: 10:30)');
        input.classList.add('campo-erro');
    } else {
        input.setCustomValidity('');
        input.classList.remove('campo-erro');
    }
}
```

**Funcionalidades:**
- `formatarHorario()`: Aplica m√°scara autom√°tica enquanto o usu√°rio digita
- `validarHorario()`: Valida o formato HH:MM ao sair do campo
- Aceita apenas hor√°rios v√°lidos (00:00 a 23:59)

#### 2. Substitui√ß√£o dos Campos Select por Input Text
**Templates modificados:**
- `templates/index.html`
- `templates/course_edit.html`
- `templates/course_duplicate.html`

**Antes:**
```html
<select name="horario_inicio[]" required>
    <option value="">Selecione o hor√°rio</option>
    <option value="06:00">06:00</option>
    <option value="07:00">07:00</option>
    <!-- ... mais 17 op√ß√µes ... -->
</select>
```

**Depois:**
```html
<input type="text" 
    name="horario_inicio[]" 
    required
    placeholder="HH:MM"
    pattern="([0-1][0-9]|2[0-3]):[0-5][0-9]"
    title="Formato: HH:MM (ex: 10:30)"
    maxlength="5"
    oninput="formatarHorario(this)"
    onblur="validarHorario(this)"
    style="width: 120px; text-align: center;"
    value="{% if duplicate_data and i < duplicate_data.horario_inicio_unidades|length %}{{ duplicate_data.horario_inicio_unidades[i] }}{% endif %}">
```

**Caracter√≠sticas do novo campo:**
- `type="text"`: Permite entrada livre
- `pattern`: Valida√ß√£o HTML5 do formato HH:MM
- `maxlength="5"`: Limita a 5 caracteres (HH:MM)
- `oninput`: Aplica m√°scara em tempo real
- `onblur`: Valida ao sair do campo
- `placeholder`: Indica o formato esperado
- `title`: Mensagem de ajuda ao passar o mouse

#### 3. Compatibilidade com Banco de Dados
**Verifica√ß√£o realizada:**

```sql
DESCRIBE turmas;
-- horario_inicio: time
-- horario_fim: time

DESCRIBE plataformas_online;
-- horario_inicio: time
-- horario_fim: time
```

**Teste de formato:**
```sql
SELECT TIME('10:30'), TIME('14:45'), TIME('09:15');
-- Resultado: ‚úÖ Aceita formato HH:MM perfeitamente
-- Retorna: datetime.timedelta objects
```

**Conclus√£o:** O banco de dados MySQL j√° est√° preparado para aceitar o formato HH:MM. O tipo `TIME` aceita valores como:
- `HH:MM` (ex: 10:30)
- `HH:MM:SS` (ex: 10:30:00)
- Ambos s√£o armazenados e recuperados corretamente

#### 4. Processamento no Backend
**Arquivo:** `services/course_service.py`

O c√≥digo j√° estava preparado para lidar com hor√°rios em formato string:

```python
def _format_course_for_template(self, course: Dict) -> Dict:
    # ...
    # Converter hor√°rios de objetos timedelta para strings
    horario_inicio_list = []
    horario_fim_list = []
    for t in turmas:
        if t.get('horario_inicio'):
            horario = t['horario_inicio']
            if hasattr(horario, 'strftime'):
                horario_inicio_list.append(horario.strftime('%H:%M'))
            elif isinstance(horario, str):
                horario_inicio_list.append(horario)
            else:
                # timedelta object
                total_seconds = int(horario.total_seconds())
                hours = total_seconds // 3600
                minutes = (total_seconds % 3600) // 60
                horario_inicio_list.append(f'{hours:02d}:{minutes:02d}')
    # ...
```

**Nenhuma modifica√ß√£o necess√°ria:** O c√≥digo j√° converte corretamente entre:
- String (HH:MM) ‚Üí MySQL TIME
- MySQL TIME (timedelta) ‚Üí String (HH:MM)

### Exemplos de Uso

#### Hor√°rios V√°lidos
- ‚úÖ 08:00 (hora cheia)
- ‚úÖ 10:15 (quinze minutos)
- ‚úÖ 14:30 (meia hora)
- ‚úÖ 09:45 (quarenta e cinco minutos)
- ‚úÖ 23:59 (√∫ltimo minuto do dia)

#### Hor√°rios Inv√°lidos
- ‚ùå 25:00 (hora inv√°lida)
- ‚ùå 10:60 (minuto inv√°lido)
- ‚ùå 1030 (sem dois pontos)
- ‚ùå 10:3 (formato incompleto)

### Experi√™ncia do Usu√°rio

#### Digita√ß√£o
1. Usu√°rio digita: `1030`
2. M√°scara aplica automaticamente: `10:30`
3. Campo fica formatado corretamente

#### Valida√ß√£o
1. Usu√°rio sai do campo
2. Sistema valida o formato
3. Se inv√°lido, mostra mensagem: "Formato inv√°lido. Use HH:MM (ex: 10:30)"
4. Campo fica destacado em vermelho at√© corre√ß√£o

#### Duplica√ß√£o de Cursos
- Hor√°rios s√£o preservados ao duplicar
- Formato √© mantido corretamente
- Funciona com qualquer hor√°rio (n√£o apenas horas cheias)

### Arquivos Modificados

1. **static/js/script.js**
   - Adicionadas fun√ß√µes `formatarHorario()` e `validarHorario()`

2. **templates/index.html**
   - Substitu√≠dos 3 campos select por input text

3. **templates/course_edit.html**
   - Substitu√≠dos 2 campos select por input text

4. **templates/course_duplicate.html**
   - Substitu√≠dos 4 campos select por input text

### Testes Realizados

#### Teste 1: Compatibilidade com Banco de Dados
```python
# Teste de inser√ß√£o e recupera√ß√£o
cursor.execute("SELECT TIME('10:30'), TIME('14:45'), TIME('09:15')")
# ‚úÖ Resultado: Aceita formato HH:MM perfeitamente
```

#### Teste 2: Convers√£o de Tipos
```python
# MySQL retorna timedelta
horario = datetime.timedelta(seconds=37800)  # 10:30
# C√≥digo converte para string
horario_str = f'{hours:02d}:{minutes:02d}'  # "10:30"
# ‚úÖ Convers√£o funciona corretamente
```

### Resultado

#### Antes
- ‚ùå Apenas hor√°rios de hora em hora (06:00, 07:00, etc.)
- ‚ùå N√£o suportava hor√°rios quebrados
- ‚ùå Select com 18 op√ß√µes fixas

#### Depois
- ‚úÖ Qualquer hor√°rio no formato HH:MM
- ‚úÖ Suporta hor√°rios quebrados (10:15, 14:45, etc.)
- ‚úÖ Input text com m√°scara autom√°tica
- ‚úÖ Valida√ß√£o em tempo real
- ‚úÖ Compat√≠vel com banco de dados existente

### Impacto

- **Flexibilidade:** Cursos podem ter hor√°rios personalizados
- **Usabilidade:** M√°scara autom√°tica facilita digita√ß√£o
- **Valida√ß√£o:** Formato √© garantido antes do envio
- **Compatibilidade:** Nenhuma mudan√ßa no banco de dados necess√°ria
- **Manutenibilidade:** C√≥digo mais simples (menos HTML)

### Observa√ß√µes T√©cnicas

1. **Tipo TIME no MySQL:**
   - Aceita formatos: HH:MM, HH:MM:SS, HHMMSS
   - Armazena internamente como timedelta
   - Retorna como timedelta em Python

2. **Convers√£o Autom√°tica:**
   - Python ‚Üí MySQL: String "10:30" √© aceita diretamente
   - MySQL ‚Üí Python: timedelta √© convertido para string no formato HH:MM

3. **Valida√ß√£o em Camadas:**
   - JavaScript: Valida√ß√£o client-side com regex
   - HTML5: Atributo `pattern` para valida√ß√£o nativa
   - Python: Valida√ß√£o server-side (j√° existente)

4. **Retrocompatibilidade:**
   - Cursos existentes com hor√°rios de hora em hora continuam funcionando
   - Novos cursos podem usar qualquer hor√°rio
   - Duplica√ß√£o preserva hor√°rios corretamente


### Corre√ß√µes Adicionais - JavaScript

Ap√≥s a implementa√ß√£o inicial, foram identificadas e corrigidas refer√™ncias a `select` no c√≥digo JavaScript que precisavam ser atualizadas para `input`:

#### Arquivos Corrigidos

1. **templates/course_edit.html**
   - Atualizado template JavaScript que cria novas plataformas dinamicamente
   - Substitu√≠dos selects por inputs com m√°scara nos hor√°rios online

2. **templates/course_duplicate.html**
   - Atualizadas 6 refer√™ncias a `querySelectorAll('select[name="horario_..."]')`
   - Corrigidas para `querySelectorAll('input[name="horario_..."]')`

3. **templates/index.html**
   - Atualizadas 6 refer√™ncias a selects de hor√°rio
   - Corrigidas para inputs em todas as fun√ß√µes JavaScript

#### Locais Espec√≠ficos Corrigidos

**course_duplicate.html:**
- Linha 98: Remo√ß√£o de required de campos de hor√°rio
- Linha 940-941: Limpeza de campos presenciais
- Linha 981: Gerenciamento de hor√°rios online
- Linha 1015: Remo√ß√£o de required e limpeza de valores
- Linha 1028: Adi√ß√£o de required aos campos de hor√°rio
- Linha 1120-1121: Array de campos presenciais
- Linha 1145: Limpeza de hor√°rios para aulas ass√≠ncronas
- Linha 1184: Limpeza de hor√°rios online

**index.html:**
- Linha 206-207: Array de campos presenciais
- Linha 257-258: Limpeza de hor√°rios para aulas ass√≠ncronas (primeira ocorr√™ncia)
- Linha 294-295: Limpeza de hor√°rios para aulas ass√≠ncronas (segunda ocorr√™ncia)
- Linha 1436-1437: Query selector de campos presenciais
- Linha 1797-1798: Verifica√ß√£o de todos os campos de hor√°rio
- Linha 1951-1952: Query selector de hor√°rios para valida√ß√£o

**course_edit.html:**
- Linha 1059-1083: Template JavaScript para cria√ß√£o din√¢mica de plataformas
  - Substitu√≠do select completo por input com m√°scara
  - Aplicadas mesmas propriedades dos inputs est√°ticos

### Resultado Final

‚úÖ **Todos os templates atualizados:**
- index.html (cria√ß√£o de cursos)
- course_edit.html (edi√ß√£o de cursos)
- course_duplicate.html (duplica√ß√£o de cursos)

‚úÖ **Todas as refer√™ncias JavaScript corrigidas:**
- querySelectorAll agora busca por `input` ao inv√©s de `select`
- L√≥gica de valida√ß√£o e limpeza funciona corretamente
- Cria√ß√£o din√¢mica de campos usa inputs com m√°scara

‚úÖ **Funcionalidades testadas:**
- Cria√ß√£o de curso com hor√°rios personalizados
- Edi√ß√£o de curso preserva hor√°rios
- Duplica√ß√£o de curso mant√©m hor√°rios
- Adi√ß√£o din√¢mica de unidades/plataformas funciona
- Valida√ß√£o de formato HH:MM ativa em todos os campos

### Status: ‚úÖ IMPLEMENTA√á√ÉO COMPLETA

Todas as p√°ginas de cria√ß√£o, edi√ß√£o e duplica√ß√£o de cursos agora suportam hor√°rios no formato livre HH:MM com m√°scara autom√°tica e valida√ß√£o em tempo real.
