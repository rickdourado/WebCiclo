# Changelog - 14/11/2025

## Corre√ß√£o de Bug: Mensagem de Erro CSRF Incorreta

### Problema Identificado
Ao tentar criar um curso online no PythonAnywhere, o sistema exibia a mensagem:
```
"Erro de Valida√ß√£o: Erro de seguran√ßa: Token CSRF inv√°lido ou expirado. Tente novamente"
```

### An√°lise do Problema
Analisando os logs do PythonAnywhere:
```
2025-11-14 17:38:55,287: Falha na cria√ß√£o do curso: ['In√≠cio das aulas da unidade 1 deve ser posterior ou igual ao fim das inscri√ß√µes (14/11/2025)', 'In√≠cio das aulas da unidade 2 deve ser posterior ou igual ao fim das inscri√ß√µes (14/11/2025)']
2025-11-14 17:38:55,288: Erro de valida√ß√£o: In√≠cio das aulas da unidade 1 deve ser posterior ou igual ao fim das inscri√ß√µes (14/11/2025)
2025-11-14 17:38:55,288: Erro de valida√ß√£o: In√≠cio das aulas da unidade 2 deve ser posterior ou igual ao fim das inscri√ß√µes (14/11/2025)
2025-11-14 17:38:55,288: Dados do formul√°rio que falharam na valida√ß√£o:
2025-11-14 17:38:55,288:   csrf_token: ImE0NWIyYjM0Nzc3OGNhMzhmNTgyMDI1ZDFlY2ZkM2M0MjRlMjM2NmIi.aRdoFA.fvY5Fb0bQaqBRw5Ndnnql_WSkLA
```

**Descoberta**: O token CSRF estava presente e v√°lido. O erro real era de **valida√ß√£o de datas**, n√£o de CSRF.

### Causa Raiz
O handler de erro 400 em `app.py` estava interceptando todos os erros HTTP 400, incluindo redirecionamentos ap√≥s erros de valida√ß√£o, e exibindo incorretamente a mensagem de erro CSRF.

### Solu√ß√£o Implementada

#### 1. Corre√ß√£o do Handler de Erro CSRF (`app.py`)
**Antes:**
```python
@app.errorhandler(400)
def csrf_error(e):
    """Handler personalizado para erros CSRF"""
    if 'CSRF' in str(e):
        logger.warning(f"üîí Erro CSRF detectado: {e}")
        flash('Erro de seguran√ßa: Token CSRF inv√°lido ou expirado. Tente novamente.', 'error')
        return redirect(request.referrer or url_for('index'))
    return e
```

**Depois:**
```python
@app.errorhandler(400)
def csrf_error(e):
    """Handler personalizado para erros CSRF"""
    # Verificar se √© realmente um erro CSRF e n√£o um erro de valida√ß√£o
    error_description = str(e.description) if hasattr(e, 'description') else str(e)
    if 'CSRF' in error_description or 'csrf' in error_description.lower():
        logger.warning(f"üîí Erro CSRF detectado: {e}")
        flash('Erro de seguran√ßa: Token CSRF inv√°lido ou expirado. Tente novamente.', 'error')
        return redirect(request.referrer or url_for('index'))
    # Se n√£o for erro CSRF, deixar o Flask tratar normalmente
    return e
```

### Resultado
Agora o sistema exibe corretamente as mensagens de erro de valida√ß√£o:
- ‚úÖ Erros de valida√ß√£o de datas s√£o exibidos corretamente
- ‚úÖ Mensagem de erro CSRF s√≥ aparece quando h√° realmente um erro CSRF
- ‚úÖ Usu√°rio recebe feedback claro sobre o que precisa corrigir

### Erro de Valida√ß√£o Original
O erro real que o usu√°rio estava enfrentando era:
- **In√≠cio das aulas deve ser posterior ou igual ao fim das inscri√ß√µes**

Isso significa que as datas de in√≠cio das aulas estavam configuradas para antes do fim das inscri√ß√µes, o que n√£o √© permitido pela l√≥gica de neg√≥cio do sistema.

### Corre√ß√£o Adicional: Valida√ß√£o de Datas para Cursos Online Ass√≠ncronos

#### Problema Secund√°rio
A valida√ß√£o de datas estava sendo aplicada a **todos** os cursos, incluindo cursos online com aulas ass√≠ncronas. Para cursos ass√≠ncronos, n√£o faz sentido validar datas de in√≠cio/fim de aulas, pois o aluno pode acessar o conte√∫do a qualquer momento.

#### Solu√ß√£o
Modificada a fun√ß√£o `_validate_aulas_dates` em `services/validation_service.py` para:
1. **Pular valida√ß√£o** de datas de aulas para cursos online ass√≠ncronos
2. **Filtrar apenas datas v√°lidas** (n√£o vazias) antes de validar
3. **Adicionar valida√ß√£o** de que fim das aulas >= in√≠cio das aulas

```python
# Para cursos online com aulas ass√≠ncronas, n√£o validar datas de aulas
modalidade = form_data.get('modalidade')
aulas_assincronas = form_data.get('aulas_assincronas')

if modalidade == 'Online' and aulas_assincronas == 'sim':
    # Cursos online ass√≠ncronos n√£o t√™m datas de in√≠cio/fim de aulas
    return
```

### Arquivos Modificados
- `app.py` - Corre√ß√£o do handler de erro 400
- `services/validation_service.py` - Corre√ß√£o da valida√ß√£o de datas para cursos online ass√≠ncronos

### Resultado Final
‚úÖ Mensagens de erro CSRF s√≥ aparecem quando h√° erro CSRF real
‚úÖ Erros de valida√ß√£o s√£o exibidos corretamente
‚úÖ Cursos online ass√≠ncronos n√£o exigem datas de in√≠cio/fim de aulas
‚úÖ Valida√ß√£o de datas mais robusta e precisa

### Pr√≥ximos Passos
- Testar no PythonAnywhere para confirmar que ambas as corre√ß√µes funcionam
- Considerar melhorar a UX para valida√ß√£o de datas no frontend (JavaScript)
- Adicionar valida√ß√£o de que in√≠cio das aulas >= fim das inscri√ß√µes tamb√©m no frontend
