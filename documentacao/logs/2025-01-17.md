# Changelog - 17/01/2025

## ğŸ”§ Melhorias e Ferramentas

### Script de Teste de ConexÃ£o com Banco de Dados
- âœ… Criado script `scripts/test_db_connection.py` para verificar conectividade com MySQL
- âœ… Script exibe informaÃ§Ãµes detalhadas:
  - ConfiguraÃ§Ãµes do banco (host, porta, usuÃ¡rio, banco)
  - VersÃ£o do MySQL
  - Lista de todas as tabelas
  - NÃºmero de registros por tabela
  - Estrutura completa de cada tabela (colunas, tipos, constraints)
- âœ… Adicionada dependÃªncia `pymysql==1.1.0` ao `requirements.txt`
- âœ… Tratamento de erros com mensagens claras e sugestÃµes de soluÃ§Ã£o

### Resultado do Teste
- âœ… ConexÃ£o com banco `cursoscarioca` estabelecida com sucesso
- âœ… MySQL versÃ£o 8.0.44 detectado
- âœ… 5 tabelas encontradas: cursos, plataformas_online, turmas, turmas_dias_semana, users
- â„¹ï¸ Banco estÃ¡ vazio (0 registros)

## ğŸ“Š Estrutura das Tabelas

### Tabela `cursos` (33 campos)
- InformaÃ§Ãµes bÃ¡sicas (tipo_aÃ§Ã£o, tÃ­tulo, descriÃ§Ã£o)
- Datas (inÃ­cio/fim inscriÃ§Ãµes)
- Modalidade (Presencial, Online, HÃ­brido)
- Acessibilidade e recursos
- Valores e bolsas
- Parceiros externos
- Status e timestamps
- Campos de auditoria (created_at, updated_at, created_by)

### Tabela `users` (7 campos)
- id, email, senha, ativo
- ultimo_acesso, created_at, updated_at

### Tabelas de Relacionamento
- `turmas` (17 campos) - Para cursos presenciais/hÃ­bridos
- `turmas_dias_semana` (3 campos) - Dias da semana das turmas
- `plataformas_online` (14 campos) - Para cursos online/hÃ­bridos

## ğŸ” MigraÃ§Ã£o de AutenticaÃ§Ã£o para Banco de Dados

### Arquivos Criados
- âœ… `repositories/user_repository.py` - RepositÃ³rio para operaÃ§Ãµes com usuÃ¡rios
- âœ… `scripts/create_admin_user.py` - Script para criar usuÃ¡rio administrador
- âœ… `scripts/test_auth.py` - Script para testar autenticaÃ§Ã£o

### AlteraÃ§Ãµes no Sistema
- âœ… `services/auth_service.py` - Migrado para usar banco de dados
  - MÃ©todo `authenticate_admin()` agora busca usuÃ¡rios na tabela `users`
  - Retorna dados do usuÃ¡rio autenticado (id, email, ultimo_acesso)
  - Atualiza campo `ultimo_acesso` a cada login
  - Novo mÃ©todo `create_user()` para criar usuÃ¡rios
  
- âœ… `app.py` - Atualizado para nova autenticaÃ§Ã£o
  - Rota `/admin/login` agora usa email ao invÃ©s de username
  - Session armazena `user_id` e `user_email` ao invÃ©s de `admin_username`
  - Logout limpa todos os dados da sessÃ£o
  
- âœ… `forms.py` - FormulÃ¡rio de login atualizado
  - Campo `username` renomeado para `Email`
  - ValidaÃ§Ã£o de email adicionada
  - Placeholder atualizado

### Funcionalidades Implementadas
- âœ… AutenticaÃ§Ã£o via banco de dados MySQL
- âœ… Busca de usuÃ¡rio por email
- âœ… VerificaÃ§Ã£o de senha com bcrypt
- âœ… AtualizaÃ§Ã£o automÃ¡tica de Ãºltimo acesso
- âœ… ValidaÃ§Ã£o de usuÃ¡rio ativo
- âœ… CriaÃ§Ã£o de novos usuÃ¡rios com hash de senha

### UsuÃ¡rios Criados
1. **Admin Principal**
   - âœ… Email: admin@cicloscarioca.rio
   - âœ… Senha: admin123 (hash bcrypt armazenado)
   - âœ… Status: Ativo
   - âœ… ID: 1

2. **Oportunidades Cariocas**
   - âœ… Email: oportunidades.cariocas@prefeitura.rio
   - âœ… Senha: GPCE#2025# (hash bcrypt armazenado)
   - âœ… Status: Ativo
   - âœ… ID: 2

### Scripts UtilitÃ¡rios
1. **create_admin_user.py**
   - Cria usuÃ¡rio administrador no banco
   - Solicita email e senha
   - Gera hash bcrypt automaticamente
   
2. **test_auth.py**
   - Testa autenticaÃ§Ã£o de usuÃ¡rios
   - Lista usuÃ¡rios cadastrados
   - Mostra Ãºltimo acesso e status

### PrÃ³ximos Passos
- â³ Migrar criaÃ§Ã£o de cursos para banco de dados
- â³ Migrar listagem de cursos para banco de dados
- â³ Implementar relacionamentos (cursos â†’ turmas â†’ dias_semana)
- â³ Implementar relacionamentos (cursos â†’ plataformas_online)
- â³ Criar views para consultas otimizadas

## ğŸ”„ InÃ­cio da MigraÃ§Ã£o de Cursos para MySQL

### Arquivos Criados
- âœ… `repositories/course_repository_mysql.py` - Novo repositÃ³rio para cursos no MySQL

### Funcionalidades Implementadas no RepositÃ³rio MySQL
- âœ… `create_course()` - Cria curso na tabela `cursos`
- âœ… `_insert_turmas()` - Insere turmas presenciais com relacionamento
- âœ… `_insert_plataforma_online()` - Insere plataforma online
- âœ… `find_by_id()` - Busca curso com turmas e plataforma
- âœ… `find_all()` - Lista todos os cursos
- âœ… Suporte para modalidades: Presencial, Online, HÃ­brido
- âœ… InserÃ§Ã£o automÃ¡tica em tabelas relacionadas (turmas_dias_semana, plataformas_dias_semana)

### Mapeamento Implementado (conforme MIGRATIONSQL.md)
- âœ… Campos da tabela `cursos` (33 campos)
- âœ… Campos da tabela `turmas` (17 campos)
- âœ… Campos da tabela `turmas_dias_semana` (3 campos)
- âœ… Campos da tabela `plataformas_online` (14 campos)
- âœ… Arrays HTML â†’ MÃºltiplas linhas no banco
- âœ… Relacionamentos 1:N (curso â†’ turmas, curso â†’ plataforma)

### AdaptaÃ§Ã£o do CourseService
- âœ… `course_service.py` adaptado para usar MySQL
- âœ… MÃ©todo `create_course()` migrado para MySQL
- âœ… MÃ©todo `_process_form_data_for_mysql()` criado
- âœ… ConversÃ£o de datas HTML â†’ MySQL (YYYY-MM-DD)
- âœ… Processamento de arrays de turmas
- âœ… Processamento de plataforma online
- âœ… Backup automÃ¡tico em CSV/PDF mantido
- âœ… MÃ©todos `get_course()` e `list_courses()` usando MySQL
- âœ… Fallback para CSV em caso de falha
- âœ… IntegraÃ§Ã£o com sessÃ£o do usuÃ¡rio (created_by)

### Funcionalidades Implementadas
- âœ… CriaÃ§Ã£o de cursos no MySQL
- âœ… Suporte para 3 modalidades (Presencial, Online, HÃ­brido)
- âœ… InserÃ§Ã£o automÃ¡tica de turmas presenciais
- âœ… InserÃ§Ã£o automÃ¡tica de plataforma online
- âœ… Relacionamento com dias da semana
- âœ… Backup em CSV/PDF para compatibilidade
- âœ… ConversÃ£o de formatos de data
- âœ… Processamento de mÃºltiplas unidades (arrays)

### Testes de CriaÃ§Ã£o de Cursos
- âœ… Script `test_create_courses.py` criado
- âœ… 5 cursos de teste criados com sucesso:
  1. Curso Presencial (3 turmas)
  2. Curso Online assÃ­ncrono
  3. Oficina Online sÃ­ncrona
  4. Curso HÃ­brido (2 turmas + plataforma)
  5. Palestra Presencial (1 turma)
- âœ… Total no banco: 8 cursos, 10 turmas, 4 plataformas online
- âœ… Relacionamentos funcionando corretamente
- âœ… Dias da semana inseridos (20 registros)

### CorreÃ§Ãµes Realizadas
- âœ… Tabela `plataformas_dias_semana` nÃ£o existe - cÃ³digo comentado
- âœ… MÃ©todo `_get_plataforma_by_course_id` ajustado
- âœ… InserÃ§Ã£o de plataformas online funcionando

### FormataÃ§Ã£o de Dados para Templates
- âœ… MÃ©todo `_format_course_for_template()` criado
- âœ… ConversÃ£o de estrutura MySQL â†’ formato template
- âœ… Turmas convertidas para strings pipe-separated
- âœ… Plataforma online integrada aos dados principais
- âœ… Datas convertidas para formato brasileiro
- âœ… Dias da semana agrupados corretamente
- âœ… MÃ©todo `list_courses()` atualizado para formatar dados
- âœ… MÃ©todo `get_course()` atualizado para formatar dados

### Compatibilidade com Templates
- âœ… Templates mantidos sem alteraÃ§Ãµes
- âœ… Dados formatados para estrutura esperada
- âœ… Campos pipe-separated (|) para mÃºltiplas turmas
- âœ… Campos de turmas e plataforma mesclados
- âœ… Retrocompatibilidade com CSV mantida

### Testes de Interface Web
- âœ… Script `test_web_interface.py` criado
- âœ… Teste de listagem: 8 cursos formatados corretamente
- âœ… Teste de busca individual: estrutura correta
- âœ… Campos pipe-separated funcionando
- âœ… Turmas presenciais: endereÃ§os, bairros, vagas, dias
- âœ… Plataforma online: nome, tipo de aula
- âœ… Curso hÃ­brido: ambas as estruturas presentes
- âœ… IntegraÃ§Ã£o com Flask testada e funcionando

### Resultados dos Testes
**Curso Presencial (ID 6):**
- 3 turmas com endereÃ§os diferentes
- Dias da semana por turma
- Vagas: 30|25|35

**Curso Online (ID 7):**
- Plataforma: Google Classroom
- Aulas assÃ­ncronas
- 100 vagas

**Curso HÃ­brido (ID 9):**
- 2 turmas presenciais
- 1 plataforma online (Microsoft Teams)
- Total: 130 vagas

### CorreÃ§Ãµes de Bugs
- âœ… Erro "'datetime.datetime object' has no attribute 'split'" corrigido
- âœ… ConversÃ£o de objetos `datetime.date` para strings
- âœ… ConversÃ£o de objetos `timedelta` (horÃ¡rios) para strings HH:MM
- âœ… Tratamento de valores None em campos opcionais
- âœ… MÃ©todo `_format_course_for_template()` robusto

### ConversÃµes Implementadas
- âœ… `datetime.date` â†’ string YYYY-MM-DD
- âœ… `timedelta` â†’ string HH:MM
- âœ… `datetime.datetime` â†’ string formatada
- âœ… Tratamento de None/null values

### Status
- âœ… AdaptaÃ§Ã£o do course_service.py concluÃ­da
- âœ… Testes de criaÃ§Ã£o de cursos bem-sucedidos
- âœ… Todas as 3 modalidades testadas e funcionando
- âœ… FormataÃ§Ã£o de dados para templates implementada
- âœ… Sistema pronto para exibir cursos na interface web
- âœ… Testes de interface web bem-sucedidos
- âœ… Bugs de conversÃ£o de tipos corrigidos
- âœ… **Sistema 100% funcional para visualizaÃ§Ã£o**
- â³ Pendente: MigraÃ§Ã£o de ediÃ§Ã£o e exclusÃ£o
- â³ Pendente: Teste manual na interface web pelo usuÃ¡rio
