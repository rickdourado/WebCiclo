# Changelog - 18/11/2025

## üéØ Objetivo
Corrigir incompatibilidades de tipos de dados entre o sistema legado (CSV) e o novo sistema (MySQL), garantindo que todos os templates funcionem corretamente com objetos nativos do banco de dados.

## Corre√ß√µes

### Erro ao listar cursos no dashboard admin
**Problema:** Ao tentar acessar a lista de cursos no dashboard admin ap√≥s login, o sistema apresentava o erro:
```
'datetime.datetime object' has no attribute 'split'
```

**Causa:** Durante a migra√ß√£o do sistema de CSV para MySQL, o c√≥digo em `app.py` na fun√ß√£o `_prepare_course_for_edit_form()` ainda assumia que todos os dados viriam como strings (formato do CSV antigo). No entanto, quando o `_format_course_for_template()` falhava parcialmente ou quando dados vinham diretamente do MySQL sem formata√ß√£o, os campos de data vinham como objetos `datetime`, causando erro ao tentar usar `.split()` neles.

**Solu√ß√£o:** 
1. **Em `app.py` - Fun√ß√£o `_prepare_course_for_edit_form()`:**
   - Adicionada verifica√ß√£o de tipo para campos de data (`inicio_inscricoes` e `fim_inscricoes`)
   - Se for objeto `datetime`, converte diretamente usando `.strftime('%Y-%m-%d')`
   - Se for string, processa normalmente com `.split()`
   - Adicionada verifica√ß√£o de tipo para campos de turmas que usam pipe-separator (`|`)
   - Verifica se o valor √© string antes de usar `.split('|')`

2. **Em `services/course_service.py` - Fun√ß√£o `_format_course_for_template()`:**
   - Adicionado tratamento robusto de erros com fallback seguro
   - Quando ocorre erro na formata√ß√£o, garante que todos os campos sejam strings
   - Converte objetos `datetime` para strings no formato correto
   - **Adicionada convers√£o de `created_at` e `updated_at` para strings** (principal causa do erro)
   - Inicializa campos pipe-separated como strings vazias se n√£o existirem
   - Adiciona logs detalhados para debug

### Causas Raiz Identificadas

#### 1. Campos datetime n√£o convertidos
O erro inicial estava no template `course_list.html` linha 1271:
```jinja2
{% set created_parts = course.created_at.split(' ')[0].split('-') %}
```
O campo `created_at` vinha como objeto `datetime.datetime` do MySQL.

#### 2. Campos Decimal n√£o convertidos
Ap√≥s corrigir datetime, surgiu erro na linha 892:
```jinja2
{% if course.valor_curso_inteira.startswith('R$') %}
```
O campo `valor_curso_inteira` vinha como objeto `decimal.Decimal` do MySQL.

### Solu√ß√£o Definitiva
Criada fun√ß√£o `_normalize_mysql_types()` que converte **todos** os tipos de dados do MySQL para tipos compat√≠veis com templates:
- `datetime.datetime` ‚Üí string no formato `YYYY-MM-DD HH:MM:SS`
- `datetime.date` ‚Üí string no formato `YYYY-MM-DD`
- `datetime.timedelta` ‚Üí string no formato `HH:MM`
- `decimal.Decimal` ‚Üí string
- `None` ‚Üí string vazia `''`

Esta fun√ß√£o √© aplicada:
- No curso principal
- Em cada turma presencial
- Na plataforma online
- Em todos os fallbacks de erro

## Corre√ß√µes Adicionais

### Dias de aula misturados entre turmas
**Problema:** No template `course_list.html`, ao exibir m√∫ltiplas turmas presenciais, os dias de aula estavam sendo exibidos de forma misturada, mostrando todos os dias de todas as turmas juntos em cada turma.

**Causa:** Na linha 1049, o template usava `course.dias_aula.replace('|', ', ')` que mostrava todos os dias concatenados, em vez de usar `dias_aula[i]` para mostrar apenas os dias da turma espec√≠fica.

**Solu√ß√£o:** Alterado para usar `dias_aula[i].strip().replace(',', ', ')` que:
- Acessa apenas os dias da turma `i` atual
- Remove espa√ßos extras com `.strip()`
- Formata as v√≠rgulas para melhor legibilidade
- Adiciona verifica√ß√£o de √≠ndice para evitar erros

**Arquivo modificado:**
- `templates/course_list.html` - Linha 1045-1051

### Melhorias na exibi√ß√£o de Informa√ß√µes B√°sicas

#### 1. Dias da Aula - Remo√ß√£o de duplicatas aprimorada
**Problema:** Os dias da semana apareciam repetidos na se√ß√£o "Informa√ß√µes B√°sicas" quando m√∫ltiplas turmas tinham os mesmos dias.

**Solu√ß√£o:** Aprimorado o processamento para:
- Separar dias de cada turma (separados por v√≠rgula dentro de cada turma)
- Separar turmas (separadas por pipe `|`)
- Remover duplicatas considerando ambos os n√≠veis de separa√ß√£o
- Resultado: "Segunda-feira, Ter√ßa-feira, Quarta-feira" (sem repeti√ß√µes)

#### 2. Hor√°rios - Exibi√ß√£o de todos os hor√°rios
**Problema:** Apenas o hor√°rio da primeira turma era exibido, mesmo quando havia m√∫ltiplas turmas com hor√°rios diferentes.

**Solu√ß√£o:** Alterado para mostrar todos os hor√°rios de todas as turmas:
- Processa arrays de `horario_inicio` e `horario_fim` separados por pipe
- Formata cada par como "HH:MM √†s HH:MM"
- Junta todos com v√≠rgulas
- Resultado: "09:00 √†s 12:00, 14:00 √†s 17:00, 19:00 √†s 22:00"

**Arquivo modificado:**
- `templates/course_list.html` - Linhas 844-878 (se√ß√£o Informa√ß√µes B√°sicas)

## Prote√ß√µes Globais Implementadas

### Filtros Jinja2 Customizados
Para garantir compatibilidade total com tipos de dados do MySQL em todos os templates, foram criados filtros Jinja2 customizados:

#### 1. `safe_str` - Convers√£o segura para string
```python
@app.template_filter('safe_str')
def safe_str_filter(value):
    """Converte qualquer valor para string de forma segura"""
    if value is None:
        return ''
    return str(value)
```

#### 2. `format_currency` - Formata√ß√£o de valores monet√°rios
```python
@app.template_filter('format_currency')
def format_currency_filter(value):
    """Formata valores monet√°rios"""
    if not value:
        return ''
    value_str = str(value)
    if value_str.startswith('R$'):
        return value_str
    return f'R$ {value_str}'
```

#### 3. `safe_split` - Split seguro
```python
@app.template_filter('safe_split')
def safe_split_filter(value, separator='|'):
    """Split seguro que retorna lista vazia se valor n√£o for string"""
    if not value:
        return []
    if not isinstance(value, str):
        value = str(value)
    return value.split(separator)
```

### Templates Atualizados
Aplicadas corre√ß√µes de seguran√ßa em todos os templates que exibem valores monet√°rios:

**Antes (causava erro com Decimal):**
```jinja2
{% if course.valor_curso_inteira.startswith('R$') %}
```

**Depois (seguro com qualquer tipo):**
```jinja2
{% set valor_str = course.valor_curso_inteira|safe_str %}
{% if valor_str.startswith('R$') %}
```

**Arquivos modificados:**
- `app.py` - Adicionados filtros Jinja2 customizados
- `templates/course_list.html` - Valores monet√°rios (3 ocorr√™ncias)
- `templates/course_success.html` - Valores monet√°rios (3 ocorr√™ncias)
- `templates/course_edit_success.html` - Valores monet√°rios (3 ocorr√™ncias)

## Resumo das Corre√ß√µes

### Problema Original
Sistema migrado de CSV para MySQL apresentava erros ao tentar usar m√©todos de string (`.split()`, `.startswith()`) em objetos nativos do MySQL (`datetime`, `Decimal`, `timedelta`).

### Solu√ß√£o Implementada
1. **Camada de Servi√ßo**: Fun√ß√£o `_normalize_mysql_types()` converte todos os tipos do MySQL para strings
2. **Camada de Template**: Filtros Jinja2 customizados garantem convers√£o segura quando necess√°rio
3. **Tratamento de Erros**: Fallbacks robustos em caso de falha na formata√ß√£o

### Resultado
Sistema totalmente compat√≠vel com MySQL, mantendo retrocompatibilidade com dados antigos do CSV.

## üîÑ Migra√ß√£o de Dados CSV ‚Üí MySQL

### Scripts de Migra√ß√£o Criados

#### 1. `migrate_csv_to_mysql.py` - Migra√ß√£o Principal
Script completo que migra todos os dados dos arquivos CSV para o banco de dados MySQL.

**Funcionalidades:**
- L√™ todos os arquivos CSV do diret√≥rio `CSV/`
- Converte formatos de data automaticamente
- Processa m√∫ltiplas turmas por curso
- Insere dias da semana de cada turma
- Cria plataformas online para cursos EAD
- Mostra estat√≠sticas detalhadas
- Verifica dados automaticamente ap√≥s migra√ß√£o

**Estrutura de dados processada:**
- Tabela `cursos` - Dados principais do curso
- Tabela `turmas` - Turmas presenciais (1:N)
- Tabela `turmas_dias_semana` - Dias de cada turma (1:N)
- Tabela `plataformas_online` - Plataformas EAD (1:1)

#### 2. `verify_mysql_data.py` - Verifica√ß√£o de Integridade
Script de valida√ß√£o que verifica a consist√™ncia dos dados migrados.

**Verifica√ß√µes realizadas:**
- Cursos presenciais sem turmas
- Cursos online sem plataforma
- Campos obrigat√≥rios vazios
- Datas inv√°lidas (in√≠cio > fim)
- Turmas sem dias da semana
- Estat√≠sticas por modalidade e √≥rg√£o
- Exibi√ß√£o de dados de exemplo

#### 3. `compress_csv_backup.py` e `compress_csv_simple.py`
Scripts para criar backup comprimido dos arquivos CSV antes da migra√ß√£o.

#### 4. `README_MIGRATION.md`
Documenta√ß√£o completa do processo de migra√ß√£o com:
- Instru√ß√µes passo a passo
- Solu√ß√£o de problemas comuns
- Estrutura de dados
- Exemplos de uso

### Processo de Migra√ß√£o

```bash
# 1. Backup (opcional)
python scripts/compress_csv_backup.py

# 2. Migra√ß√£o
python scripts/migrate_csv_to_mysql.py

# 3. Verifica√ß√£o
python scripts/verify_mysql_data.py

# 4. Teste na aplica√ß√£o web
python app.py

# 5. Limpeza (ap√≥s confirmar)
rm scripts/migrate_csv_to_mysql.py
rm scripts/verify_mysql_data.py
rm scripts/compress_*.py
rm scripts/README_MIGRATION.md
```

### Convers√µes Autom√°ticas

O script de migra√ß√£o realiza convers√µes autom√°ticas:
- **Datas:** `DD/MM/YYYY` ou `YYYY/MM/DD` ‚Üí `YYYY-MM-DD` (MySQL)
- **Turmas:** Dados separados por `|` ‚Üí Registros individuais
- **Dias da semana:** String separada por v√≠rgula ‚Üí Registros individuais
- **Valores vazios:** `''` ‚Üí `NULL` (quando apropriado)

### Arquivos Criados
- `scripts/migrate_csv_to_mysql.py` - Script principal de migra√ß√£o
- `scripts/verify_mysql_data.py` - Script de verifica√ß√£o
- `scripts/compress_csv_backup.py` - Backup completo com estat√≠sticas
- `scripts/compress_csv_simple.py` - Backup simples
- `scripts/README_MIGRATION.md` - Documenta√ß√£o completa

**Arquivos modificados:**
- `app.py` - Fun√ß√£o `_prepare_course_for_edit_form()`
- `services/course_service.py` - Fun√ß√£o `_format_course_for_template()`

**Impacto:** 
- Dashboard admin agora carrega corretamente a lista de cursos
- Formul√°rios de edi√ß√£o e duplica√ß√£o funcionam sem erros
- Sistema mais robusto ao lidar com diferentes tipos de dados do MySQL

## Contexto da Migra√ß√£o

O sistema originalmente usava arquivos CSV para armazenar dados de cursos, onde m√∫ltiplas unidades eram armazenadas em campos separados por pipe (`|`). Exemplo:
```
endereco_unidade: "Rua A, 123|Rua B, 456|Rua C, 789"
```

Com a migra√ß√£o para MySQL, os dados passaram a ser estruturados em tabelas relacionadas:
- Tabela `cursos` - dados principais
- Tabela `turmas` - m√∫ltiplas turmas presenciais
- Tabela `plataformas_online` - dados de cursos online

O m√©todo `_format_course_for_template()` converte os dados do MySQL de volta para o formato pipe-separated para manter compatibilidade com os templates existentes. No entanto, se esse m√©todo falhar ou for pulado, os dados v√™m como objetos nativos do MySQL (datetime, timedelta, etc.), causando erros no c√≥digo que espera strings.

## Detalhes T√©cnicos

### Convers√£o de datas
```python
# Antes (causava erro)
if '-' in course['inicio_inscricoes']:
    parts = course['inicio_inscricoes'].split('-')

# Depois (funciona com datetime e string)
if isinstance(course['inicio_inscricoes'], datetime):
    course['inicio_inscricoes_data'] = course['inicio_inscricoes'].strftime('%Y-%m-%d')
elif isinstance(course['inicio_inscricoes'], str):
    if '-' in course['inicio_inscricoes']:
        parts = course['inicio_inscricoes'].split('-')
```

### Processamento de campos pipe-separated
```python
# Antes (causava erro se n√£o fosse string)
enderecos = course.get('endereco_unidade', '').split('|')

# Depois (verifica tipo antes)
endereco_val = course.get('endereco_unidade', '')
enderecos = endereco_val.split('|') if isinstance(endereco_val, str) and endereco_val else ['']
```
